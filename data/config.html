<!DOCTYPE html>
<html>
  <head>
    <title>Config</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  </head>
  <body>
    <h2>Configuration</h2>
    <form id="cfgForm">
      <fieldset>
        <legend>Access Point</legend>
        <label>AP SSID <input id="apSsid" name="apSsid" /></label><br />
        <label
          >AP Pass <input id="apPass" name="apPass" type="password" /></label
        ><br />
      </fieldset>
      <fieldset>
        <label>STA SSID <input id="staSsid" name="staSsid" /></label><br />
        <label
          >STA Pass <input id="staPass" name="staPass" type="password" /></label
        ><br />
      </fieldset>
      <fieldset>
        <legend>Admin</legend>
        <label>Admin ID <input id="adminUser" name="adminUser" /></label><br />
        <label
          >Admin PW
          <input id="adminPass" name="adminPass" type="password" /></label
        ><br />
      </fieldset>
      <input type="submit" value="Save" />
    </form>
    <section>
      <h3>Laser Control</h3>
      <p>Current: <span id="laserStatus">--</span></p>
      <button type="button" onclick="laserCommand('on')">Laser On</button>
      <button type="button" onclick="laserCommand('off')">Laser Off</button>
      <form id="laserForm">
        <label>Frequency (Hz, 2000-5000)</label>
        <input
          type="number"
          id="laserFreq"
          name="freq"
          min="2000"
          max="5000"
          value="2000"
          required
        />
        <label>Duty (%)</label>
        <input
          type="number"
          id="laserDuty"
          name="duty"
          min="0"
          max="100"
          value="70"
          required
        />
        <button type="submit">Apply</button>
      </form>
    </section>
    <a href="/update">Go to OTA</a>
    <script>
      async function refreshLaserStatus() {
        try {
          const res = await fetch("/laser/status");
          if (!res.ok) throw new Error("status " + res.status);
          const data = await res.json();
          document.getElementById(
            "laserStatus"
          ).textContent = `${data.freq} Hz / ${data.duty}%`;
          document.getElementById("laserFreq").value = data.freq;
          document.getElementById("laserDuty").value = data.duty;
        } catch (err) {
          document.getElementById("laserStatus").textContent = "Unavailable";
          console.error(err);
        }
      }

      async function laserCommand(action) {
        try {
          const res = await fetch(`/laser/${action}`, { method: "POST" });
          if (!res.ok) throw new Error("status " + res.status);
          await refreshLaserStatus();
        } catch (err) {
          alert("Failed to toggle laser: " + err.message);
        }
      }

      document
        .getElementById("laserForm")
        .addEventListener("submit", async (event) => {
          event.preventDefault();
          const freq = document.getElementById("laserFreq").value;
          const duty = document.getElementById("laserDuty").value;
          try {
            const res = await fetch("/laser/set", {
              method: "POST",
              headers: { "Content-Type": "application/x-www-form-urlencoded" },
              body: `freq=${encodeURIComponent(freq)}&duty=${encodeURIComponent(
                duty
              )}`,
            });
            if (!res.ok) {
              const text = await res.text();
              throw new Error(text || "status " + res.status);
            }
            await refreshLaserStatus();
          } catch (err) {
            alert("Failed to update laser: " + err.message);
          }
        });

      refreshLaserStatus();

      (async () => {
        const r = await fetch("/api/config");
        if (!r.ok) return;
        const cfg = await r.json();
        for (const k in cfg) {
          const el = document.getElementById(k);
          if (el) el.value = cfg[k];
        }
      })();

      document
        .getElementById("cfgForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const body = {
            apSsid: document.getElementById("apSsid").value,
            apPass: document.getElementById("apPass").value,
            staSsid: document.getElementById("staSsid").value,
            staPass: document.getElementById("staPass").value,
            adminUser: document.getElementById("adminUser").value,
            adminPass: document.getElementById("adminPass").value,
            version: Number(document.getElementById("version").value || 0),
          };
          const r = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (r.status === 204) {
            alert("Saved!");
            // 네트워크가 바뀌면 연결이 잠깐 끊길 수 있어요.
          } else {
            alert("Save failed: " + (await r.text()));
          }
        });
    </script>
  </body>
</html>
