<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Config</title>
    <meta name="viewport" content="width=device-width, ,initial-scale=1.0" />

    <style>
      * {
        box-sizing: border-box;
      }
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
      }
      fieldset {
        margin-bottom: 15px;
        padding: 10px;
      }
      label {
        display: inline-block;
        width: 100px;
        margin-bottom: 5px;
      }
      input,
      select {
        width: 200px;
        margin-bottom: 5px;
      }
      button {
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <h2>Configuration</h2>
    <form id="cfgForm">
      <fieldset>
        <legend>Access Point</legend>
        <label>AP SSID</label>
        <input id="apSsid" name="apSsid" /><br />
        <label>AP Pass</label>
        <input id="apPass" name="apPass" type="password" /><br />
      </fieldset>
      <fieldset>
        <legend>Station</legend>
        <label>STA SSID</label>
        <select id="staSsid" name="staSsid">
          <option value="" hidden>스캔 중...</option>
        </select>
        <button type="button" id="btnScan">다시 스캔</button>
        <br />
        <label>STA Pass</label>
        <input id="staPass" name="staPass" type="password" /><br />
      </fieldset>
      <fieldset>
        <legend>Server</legend>
        <label>Url </label>
        <input id="serverUrl" name="serverUrl" /><br />
        <label>Port </label>
        <input id="port" name="port" /><br />
      </fieldset>
      <fieldset>
        <legend>Admin</legend>
        <label>Admin ID</label>
        <input id="adminUser" name="adminUser" /><br />
        <label>Admin PW</label>
        <input id="adminPass" name="adminPass" type="password" /><br />
      </fieldset>
      <fieldset>
        <legend>Others</legend>
        <label>Device ID</label>
        <input id="deviceId" name="deviceId" /><br />
      </fieldset>
      <input type="submit" value="Save" />
    </form>
    <a href="/update">Go to OTA</a>
    <script>
      (async () => {
        const r = await fetch("/api/config");
        if (!r.ok) return;
        const cfg = await r.json();
        for (const k in cfg) {
          const el = document.getElementById(k);
          if (el) el.value = cfg[k];
        }
      })();

      document
        .getElementById("cfgForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const body = {
            apSsid: document.getElementById("apSsid").value,
            apPass: document.getElementById("apPass").value,
            staSsid: document.getElementById("staSsid").value,
            staPass: document.getElementById("staPass").value,
            adminUser: document.getElementById("adminUser").value,
            adminPass: document.getElementById("adminPass").value,
            serverUrl: document.getElementById("serverUrl").value,
            port: document.getElementById("port").value,
            version: Number(document.getElementById("version").value || 0),
            deviceId: document.getElementById("deviceId").value,
          };
          const r = await fetch("/api/config", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          });
          if (r.status === 204) {
            alert("Saved!");
            // 네트워크가 바뀌면 연결이 잠깐 끊길 수 있어요.
          } else {
            alert("Save failed: " + (await r.text()));
          }
        });

      async function scanWifi() {
        const sel = document.getElementById("staSsid");
        const btn = document.getElementById("btnScan");
        btn.disabled = true;
        sel.innerHTML = `<option value="" hidden>스캔 중...</option>`;
        try {
          const res = await fetch("/api/wifi/scan", { cache: "no-store" });
          if (!res.ok) throw new Error("scan failed");
          /** @type {{ssid:string,rssi:number,enc:string,bssid:string}[]} */
          const list = await res.json();

          // SSID가 같은 항목은 RSSI(신호세기)가 가장 센 것만 남기기
          const best = new Map();
          for (const ap of list) {
            if (!ap.ssid) continue; // 숨김 SSID 제외
            const have = best.get(ap.ssid);
            if (!have || ap.rssi > have.rssi) best.set(ap.ssid, ap);
          }
          const uniq = Array.from(best.values()).sort(
            (a, b) => b.rssi - a.rssi
          );

          sel.innerHTML = "";
          for (const ap of uniq) {
            const opt = document.createElement("option");
            const lock = ap.enc && ap.enc !== "OPEN" ? " 🔒" : "";
            opt.value = ap.ssid;
            opt.textContent = `${ap.ssid}${lock} (${ap.rssi} dBm)`;
            sel.appendChild(opt);
          }
          // 목록 없으면 수동 입력 옵션 제공
          if (!sel.options.length) {
            const o = document.createElement("option");
            o.value = "";
            o.textContent = "주변에서 SSID를 찾지 못함";
            sel.appendChild(o);
          }
        } catch (e) {
          sel.innerHTML = "";
          const o = document.createElement("option");
          o.value = "";
          o.textContent = "스캔 실패";
          sel.appendChild(o);
          console.error(e);
        } finally {
          btn.disabled = false;
        }
      }

      document.getElementById("btnScan").addEventListener("click", scanWifi);
      // 페이지 로드시 자동 스캔
      window.addEventListener("DOMContentLoaded", scanWifi);
    </script>
  </body>
</html>
